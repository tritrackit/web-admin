<div class="unit-tracker-container">
  <!-- Top Section: Search and Filters -->
  <div class="top-section" 
       fxLayout="row" 
       fxLayout.xs="column" 
       fxLayout.sm="column"
       fxLayoutAlign="space-between center"
       fxLayoutAlign.xs="stretch"
       fxLayoutAlign.sm="stretch"
       fxLayoutGap="24px"
       fxLayoutGap.xs="16px"
       fxLayoutGap.sm="16px">
    <!-- Search Bar -->
    <div class="search-section" fxFlex="1 1 auto" fxFlex.xs="100" fxFlex.sm="100">
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Search by Chassis No</mat-label>
        <input matInput [formControl]="searchControl" placeholder="Search by Chassis No">
        <mat-icon matPrefix>search</mat-icon>
      </mat-form-field>
    </div>

    <!-- Filter Buttons -->
    <div class="filter-section" 
         fxLayout="row" 
         fxLayout.xs="column" 
         fxLayout.sm="row wrap"
         fxLayoutGap="12px" 
         fxLayoutGap.xs="8px"
         fxLayoutGap.sm="8px"
         fxLayoutAlign="end center"
         fxLayoutAlign.xs="stretch"
         fxLayoutAlign.sm="start">
      <span class="filter-label" fxHide.xs="false" fxHide.sm="false">FILTER BY:</span>
      
      <!-- Color Filter -->
      <mat-form-field appearance="outline" class="filter-dropdown" fxFlex.xs="100" fxFlex.sm="1 1 calc(50% - 6px)">
        <mat-select [value]="selectedColorFilter" (selectionChange)="onColorFilterChange($event.value)" placeholder="Color">
          <mat-option [value]="null">All Colors</mat-option>
          <mat-option *ngFor="let color of colors" [value]="color">{{ color }}</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Model Filter -->
      <mat-form-field appearance="outline" class="filter-dropdown" fxFlex.xs="100" fxFlex.sm="1 1 calc(50% - 6px)">
        <mat-select [value]="selectedModelFilter" (selectionChange)="onModelFilterChange($event.value)" placeholder="Model">
          <mat-option [value]="null">All Models</mat-option>
          <mat-option *ngFor="let model of models" [value]="model.modelId">{{ model.modelName }}</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Warehouse Filter -->
      <mat-form-field appearance="outline" class="filter-dropdown" fxFlex.xs="100" fxFlex.sm="1 1 calc(50% - 6px)">
        <mat-select [value]="selectedWarehouseFilter" (selectionChange)="onWarehouseFilterChange($event.value)" placeholder="Warehouse">
          <mat-option [value]="null">All Locations</mat-option>
          <mat-option *ngFor="let location of locations" [value]="location.locationId">{{ location.name }}</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Status Filter -->
      <mat-form-field appearance="outline" class="filter-dropdown" fxFlex.xs="100" fxFlex.sm="1 1 calc(50% - 6px)">
        <mat-select [value]="selectedStatusFilter" (selectionChange)="onStatusFilterChange($event.value)" placeholder="Status">
          <mat-option [value]="null">All Statuses</mat-option>
          <mat-option *ngFor="let status of statuses" [value]="status.statusId">{{ status.name }}</mat-option>
        </mat-select>
      </mat-form-field>
    </div>
  </div>

  <!-- Divider -->
  <mat-divider class="section-divider"></mat-divider>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container" fxLayout="column" fxLayoutAlign="center center">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Loading units...</p>
  </div>

  <!-- Desktop Table Section -->
  <div *ngIf="!loading" class="table-section desktop-table">
    <table mat-table [dataSource]="dataSource" class="units-table">
      <!-- Checkbox Column -->
      <ng-container matColumnDef="select">
        <th mat-header-cell *matHeaderCellDef>
          <mat-checkbox
            [checked]="selectAllChecked"
            [indeterminate]="selectAllIndeterminate"
            (change)="onSelectAllChange($event.checked)">
          </mat-checkbox>
        </th>
        <td mat-cell *matCellDef="let row">
          <mat-checkbox
            [checked]="row.selected"
            (change)="onRowSelectChange(row, $event.checked)">
          </mat-checkbox>
        </td>
      </ng-container>

      <!-- RFID ID Column -->
      <ng-container matColumnDef="rfid">
        <th mat-header-cell *matHeaderCellDef>RFID ID</th>
        <td mat-cell *matCellDef="let row">{{ row.rfid }}</td>
      </ng-container>

      <!-- Chassis No Column -->
      <ng-container matColumnDef="chassisNo">
        <th mat-header-cell *matHeaderCellDef>Chassis No</th>
        <td mat-cell *matCellDef="let row">{{ row.chassisNo }}</td>
      </ng-container>

      <!-- Color Column -->
      <ng-container matColumnDef="color">
        <th mat-header-cell *matHeaderCellDef>Color</th>
        <td mat-cell *matCellDef="let row">{{ row.color }}</td>
      </ng-container>

      <!-- Model Column -->
      <ng-container matColumnDef="model">
        <th mat-header-cell *matHeaderCellDef>Model</th>
        <td mat-cell *matCellDef="let row">{{ row.model }}</td>
      </ng-container>

      <!-- Location Column (Dropdown) -->
      <ng-container matColumnDef="location">
        <th mat-header-cell *matHeaderCellDef>Location</th>
        <td mat-cell *matCellDef="let row">
          <div class="dropdown-cell">
            <mat-form-field appearance="outline" class="inline-select">
              <mat-select 
                [value]="row.locationId" 
                (selectionChange)="onLocationChange(row, $event.value)"
                [disabled]="isUpdating(row.unitId)">
                <mat-option *ngFor="let location of locations" [value]="location.locationId">
                  {{ location.name }}
                </mat-option>
              </mat-select>
            </mat-form-field>
            <mat-spinner *ngIf="isUpdating(row.unitId)" diameter="20" class="update-spinner"></mat-spinner>
          </div>
        </td>
      </ng-container>

      <!-- Status Column (Dropdown) -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef>Status</th>
        <td mat-cell *matCellDef="let row">
          <div class="dropdown-cell">
            <mat-form-field appearance="outline" class="inline-select">
              <mat-select 
                [value]="row.statusId" 
                (selectionChange)="onStatusChange(row, $event.value)"
                [disabled]="isUpdating(row.unitId)">
                <mat-option *ngFor="let status of statuses" [value]="status.statusId">
                  {{ status.name }}
                </mat-option>
              </mat-select>
            </mat-form-field>
            <mat-spinner *ngIf="isUpdating(row.unitId)" diameter="20" class="update-spinner"></mat-spinner>
          </div>
        </td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef></th>
        <td mat-cell *matCellDef="let row">
          <button mat-raised-button color="accent" class="more-info-button" (click)="onMoreInfo(row)">
            MORE INFO
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
    </table>
  </div>

  <!-- Mobile Card Section -->
  <div *ngIf="!loading" class="mobile-cards-section">
    <!-- Mobile Select All Header -->
    <div class="mobile-select-all-header">
      <mat-checkbox
        [checked]="selectAllChecked"
        [indeterminate]="selectAllIndeterminate"
        (change)="onSelectAllChange($event.checked)"
        class="mobile-select-all-checkbox">
        <span class="select-all-label">Select All</span>
      </mat-checkbox>
    </div>
    
    <mat-card *ngFor="let row of dataSource.data" class="unit-card">
      <mat-card-content>
        <!-- Card Header with Checkbox -->
        <div class="card-header">
          <mat-checkbox
            [checked]="row.selected"
            (change)="onRowSelectChange(row, $event.checked)"
            class="card-checkbox">
          </mat-checkbox>
          <div class="card-title-section">
            <h3 class="card-chassis">{{ row.chassisNo }}</h3>
            <span class="card-rfid">{{ row.rfid }}</span>
          </div>
        </div>

        <!-- Card Body -->
        <div class="card-body">
          <div class="card-row">
            <span class="card-label">Color:</span>
            <span class="card-value">{{ row.color }}</span>
          </div>
          <div class="card-row">
            <span class="card-label">Model:</span>
            <span class="card-value">{{ row.model }}</span>
          </div>
          
          <!-- Location Dropdown -->
          <div class="card-row">
            <span class="card-label">Location:</span>
            <div class="card-dropdown">
              <mat-form-field appearance="outline" class="mobile-select">
                <mat-select 
                  [value]="row.locationId" 
                  (selectionChange)="onLocationChange(row, $event.value)"
                  [disabled]="isUpdating(row.unitId)">
                  <mat-option *ngFor="let location of locations" [value]="location.locationId">
                    {{ location.name }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
              <mat-spinner *ngIf="isUpdating(row.unitId)" diameter="18" class="mobile-spinner"></mat-spinner>
            </div>
          </div>

          <!-- Status Dropdown -->
          <div class="card-row">
            <span class="card-label">Status:</span>
            <div class="card-dropdown">
              <mat-form-field appearance="outline" class="mobile-select">
                <mat-select 
                  [value]="row.statusId" 
                  (selectionChange)="onStatusChange(row, $event.value)"
                  [disabled]="isUpdating(row.unitId)">
                  <mat-option *ngFor="let status of statuses" [value]="status.statusId">
                    {{ status.name }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
              <mat-spinner *ngIf="isUpdating(row.unitId)" diameter="18" class="mobile-spinner"></mat-spinner>
            </div>
          </div>
        </div>

        <!-- Card Actions -->
        <div class="card-actions">
          <button mat-raised-button color="accent" class="mobile-info-button" (click)="onMoreInfo(row)">
            <mat-icon>info</mat-icon>
            More Info
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Selection Info and Actions -->
  <div *ngIf="getSelectedCount() > 0" 
       class="selection-section" 
       fxLayout="row" 
       fxLayout.xs="column"
       fxLayout.sm="column"
       fxLayoutAlign="space-between center"
       fxLayoutAlign.xs="stretch"
       fxLayoutAlign.sm="stretch"
       fxLayoutGap="8px">
    <div class="selection-info">
      <span class="selection-count">{{ getSelectedCount() }} unit(s) selected</span>
    </div>
    <div class="selection-actions" 
         fxLayout="row" 
         fxLayout.xs="column"
         fxLayout.sm="row"
         fxLayoutGap="8px"
         fxLayoutAlign.xs="stretch"
         fxLayoutAlign.sm="end">
      <button mat-raised-button color="primary" (click)="openBulkUpdateDialog()" [disabled]="bulkUpdating" fxFlex.xs="100" fxFlex.sm="none">
        <mat-icon>edit</mat-icon>
        <span fxHide.xs="false" fxHide.sm="false">Update Selected</span>
        <span fxShow.xs="false" fxShow.sm="false">Update</span>
      </button>
      <button mat-button color="warn" (click)="clearSelection()" [disabled]="bulkUpdating" fxFlex.xs="100" fxFlex.sm="none">
        <mat-icon>clear</mat-icon>
        Clear Selection
      </button>
    </div>
  </div>

  <!-- Pagination Section -->
  <div class="pagination-section" 
       fxLayout="row" 
       fxLayout.xs="column"
       fxLayout.sm="row"
       fxLayoutAlign="space-between center"
       fxLayoutAlign.xs="center"
       fxLayoutAlign.sm="space-between"
       fxLayoutGap="16px">
    <div class="pagination-info">
      <span>Showing {{ getStartRecord() }}-{{ getEndRecord() }} from {{ total }} records</span>
    </div>
    <div class="pagination-controls" fxLayout="row" fxLayoutGap="8px">
      <button mat-icon-button 
              [disabled]="!hasPreviousPage()" 
              (click)="goToPreviousPage()"
              class="pagination-button">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <button mat-icon-button 
              [disabled]="!hasNextPage()" 
              (click)="goToNextPage()"
              class="pagination-button">
        <mat-icon>arrow_forward</mat-icon>
      </button>
    </div>
  </div>
</div>
